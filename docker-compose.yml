version: '3.8'

services:
  # --- 1. Database ---
  # Internal only. No public ports exposed.
  db:
    image: postgres:15-alpine
    container_name: cert_db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: certdb
      # Reads from your local .env file on the server
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      # Persistent storage managed by Docker
      - postgres_data:/var/lib/postgresql/data
    # Log Rotation: Prevents disk from filling up
    logging:
      driver: "json-file"
      options:
        max-size: "10m" # Max size of a single log file
        max-file: "3"   # Keep only the last 3 files

  # --- 2. Backend (Go) ---
  # Internal only. Talks to DB via internal network.
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cert_backend
    restart: always
    depends_on:
      - db
    # Inject secrets at runtime from the host file
    env_file:
      - .env
    environment:
      # OVERRIDE: We must change 'localhost' to 'db' (the service name)
      DB_CONN: "postgres://postgres:${DB_PASSWORD}@db:5432/certdb?sslmode=disable"
      PORT: "8080"
      # Used for generating email links (Verify/Reset)
      # In prod, change this to "https://your-domain.com"
      FRONTEND_URL: "http://localhost" 
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- 3. Frontend (Nginx + React) ---
  # The only public facing container.
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cert_frontend
    restart: always
    ports:
      - "80:80" # Standard HTTP port
    depends_on:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Define the named volume for persistence
volumes:
  postgres_data: